# Runbook: Deploy simple whoami stack in Docker Swarm

**Last updated:** 2025-12-14  
**Frequency:** One-time / Testing

## Purpose

Deploy a minimal `whoami` service to a Docker Swarm cluster to verify that scheduling, published ports, basic networking, and shared storage work as expected using a demo stack.

## Context

- **Environment:** demo (non-critical test service)
- **Cluster:** `docker-swarm-01` (manager), `docker-swarm-02`, `docker-swarm-03` (workers)
- **Stack name:** `whoami-demo-1`
- **Data path:** `/srv/swarm/demo/whoami/whoami-demo-1/data` (NFS, owned by `svc-demo`'s UID/GID)
- **Scope:** new demo service only; no existing stacks are modified

## Prerequisites

- [ ] SSH access to the Swarm manager node  
- [ ] User on the manager is allowed to run `docker` and `docker stack`  
- [ ] Docker Swarm is already initialized and the cluster is healthy  
- [ ] NFS mount `/srv/swarm` is configured and working on all Swarm nodes  
- [ ] No existing stack named `whoami-demo-1` is deployed

## Steps

### 1. Preparation

1. SSH to the Swarm manager node:
   - `ssh <swarm-admin>@docker-swarm-01`
2. Ensure the manager has network access to the Git hosting service (GitHub/Gitea) in order to download the stack file.
3. Verify that no stack named `whoami-demo-1` exists:
   - `docker stack ls | grep whoami-demo-1 || echo "no existing stack"`

### 2. Execution

1. Download the current version of the demo stack file to the manager, for example:

   ```bash
   mkdir -p /opt/swarm/demo/whoami
   wget https://github.com/kord1an/homelab/raw/refs/heads/main/swarm/stacks/whoami-demo-1-stack.yml \
        -O /opt/swarm/demo/whoami/whoami-demo-1-stack.yml
   ```

2. Ensure the data directory exists on the NFS mount and is owned by the demo UID/GID:

   ```
   sudo mkdir -p /srv/swarm/demo/whoami/whoami-demo-1/data
   sudo chown -R svc-demo:svc-demo /srv/swarm/demo/whoami/whoami-demo-1
   ```

3. Edit the downloaded `whoami-demo-1-stack.yml` so that:
   - the volume path points to `/srv/swarm/demo/whoami/whoami-demo-1/data`
   - the service runs as `svc-demo` (UID/GID of that account)
   - the desired port (for example 8000) is published on the Swarm nodes

4. Deploy the stack using the edited file:

   ```
   docker stack deploy \
     -c /opt/swarm/demo/whoami/whoami-demo-1-stack.yml \
     whoami-demo-1
   ```

5. Wait a few seconds for Swarm to schedule and start all tasks.

### 3. Verification

1. Check the stack and tasks on the manager:

   ```bash
   docker stack ps whoami-demo-1
   ```

   - All tasks should be in `Running` state.

2. From a client that can reach the Swarm nodes, send an HTTP request to the published port (example with node IP and port 8000):

   ```bash
   curl http://<swarm-node-ip>:8000
   ```

   - The response should contain headers and information generated by the `traefik/whoami` service.

3. Check Docker logs for errors related to the stack:

   ```bash
   docker service logs whoami-demo-1_app --tail 50
   ```

### 4. Optional scaling test

1. Scale the service up to a high replica count to observe Swarm scheduling behaviour, for example:

   ```bash
   docker service scale whoami-demo-1_app=200
   ```

2. Inspect how tasks are distributed across Swarm nodes:

   ```bash
   docker service ps whoami-demo-1_app
   docker node ls
   ```

3. After the test, scale the service back down to a reasonable level:

   ```bash
   docker service scale whoami-demo-1_app=1
   ```

## Rollback

If the deployment needs to be reverted or the test is no longer required:

1. Remove the stack from the Swarm cluster:

   ```bash
   docker stack rm whoami-demo-1
   ```

2. Confirm that no tasks or services related to `whoami-demo-1` remain:

   ```bash
   docker stack ls | grep whoami-demo-1 || echo "stack removed"
   docker service ls | grep whoami-demo-1 || echo "no services"
   ```

3. Optionally remove the stack file and data directory if they are no longer needed:

   ```bash
   rm -f /opt/swarm/demo/whoami/whoami-demo-1-stack.yml
   # Only if you are sure the demo data can be discarded:
   # sudo rm -rf /srv/swarm/demo/whoami/whoami-demo-1
   ```

## Notes / Troubleshooting

- If tasks stay in `Pending` or `Failed` state, check:
  - node availability: `docker node ls`
  - image pull errors: `docker service logs whoami-demo-1_app`
- If the HTTP request does not reach the service:
  - verify which ports are published in the stack file,
  - ensure no local firewall is blocking access to the published port on Swarm nodes.
- This runbook is intended for a non-critical demo service and should not modify any existing production stacks.